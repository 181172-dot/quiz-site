<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç®¡ç†è€…ç”»é¢</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
  <div class="card">
    <h2>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <input id="id" placeholder="ID">
    <input id="pw" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn-main" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <p id="loginMsg"></p>
  </div>

  <!-- å•é¡Œè¿½åŠ  -->
  <div class="card">
    <h3>â• å•é¡Œã‚’è¿½åŠ </h3>
    <input id="qname" placeholder="å•é¡Œåï¼ˆä¾‹ï¼šç¬¬1å•ï¼‰">
    <button class="btn-main" onclick="addButton()">è¿½åŠ </button>
  </div>

  <!-- å•é¡Œä¸€è¦§ -->
  <div id="buttons"></div>

  <!-- éè¡¨ç¤º -->
  <div class="card">
    <button class="btn-danger" onclick="hide()">å…¨ä½“ã‚’éè¡¨ç¤º</button>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let loggedIn = false;

/* ===== ãƒ­ã‚°ã‚¤ãƒ³ ===== */
function login() {
  socket.emit("login", {
    id: document.getElementById("id").value,
    pw: document.getElementById("pw").value
  });
}

socket.on("loginOK", () => {
  loggedIn = true;
  document.getElementById("loginMsg").textContent = "ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ";
});

socket.on("loginNG", () => {
  document.getElementById("loginMsg").textContent = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—";
});

/* ===== åˆæœŸãƒ‡ãƒ¼ã‚¿ ===== */
socket.on("init", data => {
  renderButtons(data.buttons);
});

/* ===== ãƒœã‚¿ãƒ³æ›´æ–° ===== */
socket.on("buttons", btns => {
  renderButtons(btns);
});

/* ===== å•é¡Œè¿½åŠ  ===== */
function addButton() {
  if (!loggedIn) return alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„");
  const name = document.getElementById("qname").value;
  if (!name) return;

  socket.emit("addButton", {
    id: Date.now().toString(),
    name
  });
  document.getElementById("qname").value = "";
}

/* ===== è¡¨ç¤º ===== */
function show(id) {
  socket.emit("show", id);
}

/* ===== å‰Šé™¤ ===== */
function del(id) {
  if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  socket.emit("deleteButton", id);
}

/* ===== éè¡¨ç¤º ===== */
function hide() {
  socket.emit("hide");
}

/* ===== ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ===== */
function upload(event, id) {
  if (!loggedIn) return;

  const fd = new FormData();
  for (const file of event.target.files) {
    fd.append("images", file);
  }

  fetch("/upload", {
    method: "POST",
    body: fd
  })
  .then(res => res.json())
  .then(urls => {
    socket.emit("addImages", { id, images: urls });
  });
}

/* ===== UIæç”» ===== */
function renderButtons(btns) {
  const area = document.getElementById("buttons");
  area.innerHTML = "";

  for (const id in btns) {
    area.innerHTML += `
      <div class="card problem">
        <div>
          <h4>${btns[id].name}</h4>
          <input type="file" multiple onchange="upload(event,'${id}')">
        </div>
        <div class="problem-actions">
          <button class="btn-main" onclick="show('${id}')">è¡¨ç¤º</button>
          <button class="btn-danger" onclick="del('${id}')">å‰Šé™¤</button>
        </div>
      </div>
    `;
  }
}
</script>

</body>
</html>
